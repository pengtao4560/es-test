----------以下内容来自官网-待整理-----------------------------------------------------------
[官网介绍：](https://redis.io/topics/persistence#snapshotting)

Redis Persistence
Redis 提供了一系列不同的持久性选项：

RDB（Redis 数据库）：**RDB 按指定的时间间隔内执行 将数据集的快照写入到磁盘中的操作。**
AOF（仅追加文件 Append Only File）：AOF 持久性已日志的形式来记录服务器接收的每个写入操作(读操作不可记录)，这些操作将在服务器启动时再次播放，从而重建原始数据集。

使用与 Redis 协议本身相同的格式以仅追加的方式记录命令。
Redis 能够在日志变得太大时在后台重写日志。
无持久性：如果您愿意，可以完全禁用持久性，前提是您希望数据在服务器运行期间一直存在。
RDB + AOF：可以在同一实例中同时组合 AOF 和 RDB。请注意，在这种情况下，当 Redis 重新启动时，AOF 文件将用于重建原始数据集，因为它保证是最完整的。
要了解的最重要的事情是RDB和AOF持久性之间的不同权衡。让我们从RDB开始：

####RDB 的优势

    RDB 是 Redis 数据的非常紧凑的单文件时间点表示形式。RDB文件非常适合备份。例如，您可能希望在最近 24 小时内每小时存档一次 RDB 文件，并希望每天保存一个 RDB 快照，
    持续 30 天。这使您可以在发生灾难时轻松还原数据集的不同版本。
    RDB非常适合灾难恢复，它是一个紧凑的文件，可以传输到远数据中心或Amazon S3（可能加密）。
    RDB最大限度地提高了Redis的性能，因为Redis父进程为了持久化而需要做的唯一工作就是分叉一个子进程，它将完成其余的所有事情。父进程永远不会执行磁盘 I/O 或类似操作。
    与AOF相比，RDB允许使用大型数据集更快地重新启动。
    在副本上，RDB 支持在重新启动和故障转移后进行部分重新同步。

#### RDB的缺点

    如果您需要在 Redis 停止工作（例如在断电后）将数据丢失的可能性降至最低，则 RDB 并不好。您可以在生成 RDB 的位置配置不同的保存点（例如，在对数据集进行至少 5 分钟和 100 次写入后，
    您可以有多个保存点）。但是，您通常每五分钟或更长时间创建一个RDB快照，因此，如果Redis因任何原因在没有正确关闭的情况下停止工作，您应该准备好丢失最新分钟的数据。
    RDB 需要经常分叉（），以便使用子进程在磁盘上持久保存。如果数据集很大，则 fork（） 可能会非常耗时，并且如果数据集非常大且 CPU 性能不是很高，
    则可能导致 Redis 停止为客户端提供服务数毫秒甚至一秒钟。AOF 还需要分叉（），但频率较低，您可以调整重写日志的频率，而无需在持久性上进行任何权衡。

#### AOF 优势

    使用 AOF Redis 更加持久：您可以拥有不同的 fsync 策略：根本没有 fsync，每秒 fsync 一次，每次查询时 fsync。使用 fsync 的默认策略，
    每秒写入性能仍然很好（fsync 是使用后台线程执行的，当没有 fsync 正在进行时，主线程将努力执行写入），但您只能损失一秒钟的写入。
    AOF 日志是仅追加日志，因此在断电时不会出现寻道或损坏问题。即使由于某种原因（磁盘已满或其他原因），日志也能够以半写的命令结尾，该工具也可以轻松修复它。redis-check-aof
    AOF 以易于理解和解析的格式一个接一个地包含所有操作的日志。您甚至可以轻松导出AOF文件。例如，即使您不小心使用 FLUSHALL 命令刷新了所有内容，
    只要在此期间未执行日志重写，您仍然可以通过停止服务器、删除最新命令并再次重新启动 Redis 来保存数据集。

#### AOF 的缺点

    AOF 文件通常大于同一数据集的等效 RDB 文件。
    AOF 可能比 RDB 慢，具体取决于确切的 fsync 策略。一般来说，将 fsync 设置为每秒一次的性能仍然非常高，并且在禁用 fsync 的情况下，即使在高负载下，它也应该与 RDB 一样快。
    尽管如此，RDB仍然能够提供更多关于最大延迟的保证，即使在巨大的写入负载的情况下也是如此。
红< 7.0

如果在重写期间对数据库有写入操作，AOF 可能会使用大量内存（这些写入操作在内存中，并在末尾写入新的 AOF）。
在重写期间到达的所有写入命令都会写入磁盘两次。
Redis 可以在重写结束时冻结写入这些写入命令并将其同步到新的 AOF 文件。

好的，那么我应该使用什么呢？

一般迹象表明，如果你想要一定程度的数据安全性，你应该使用这两种持久性方法，与PostgreSQL可以为你提供的数据安全相媲美。

如果您非常关心您的数据，但在发生灾难时仍然可以忍受几分钟的数据丢失，那么您可以单独使用RDB。

有许多用户单独使用 AOF，但我们不鼓励这样做，因为不时拥有 RDB 快照对于执行数据库备份、加快重新启动速度以及在 AOF 引擎中出现错误是一个好主意。

注意：由于所有这些原因，**我们最终可能会在未来将AOF和RDB统一为一个单一的持久性模型（长期计划）。**

以下各节将说明有关这两种持久性模型的更多详细信息。


快照
默认情况下，Redis 将数据集的快照保存在磁盘上，保存在名为 的二进制文件中。您可以配置 Redis，使其在数据集中至少有 M 个更改时每 N 秒保存一次数据集，
或者您可以手动调用 SAVE 或 BGSAVE 命令。**dump.rdb**

例如，如果至少更改了 1000 个键，则此配置将使 Redis 每 60 秒自动将数据集转储到磁盘：

save 60 1000
此策略称为快照。

它是如何运作的
每当 Redis 需要将数据集转储到磁盘时，都会发生以下情况：

Redis forks.我们现在有一个孩子和一个父进程。

子级开始将数据集写入临时 RDB 文件。

当子级完成写入新的 RDB 文件时，它将替换旧的 RDB 文件。

此方法允许 Redis 从写入时复制语义中受益。


仅追加文件
快照不是很持久。如果运行 Redis 的计算机停止运行、电源线出现故障或实例意外发生故障，则写入 Redis 的最新数据将丢失。虽然对于某些应用程序来说，这可能不是什么大问题，但存在完全持久性的用例，在这些情况下，仅使用Redis快照并不是一个可行的选择。kill -9

仅追加文件是 Redis 的替代、完全持久的策略。它在1.1版中可用。

您可以在配置文件中打开 AOF：

appendonly yes

从现在开始，每次 Redis 收到更改数据集的命令（例如 SET）时，它都会将其附加到 AOF。当您重新启动 Redis 时，它将重新播放 AOF 以重建状态。

从 Redis 7.0.0 开始，Redis 使用多部分 AOF 机制。也就是说，原始的单个 AOF 文件被拆分为基本文件（最多一个）和增量文件（可能有多个）。基文件表示重写 AOF 时存在的数据的初始（RDB 或 AOF 格式）快照。增量文件包含自上次创建基本 AOF 文件以来的增量更改。所有这些文件都放在单独的目录中，并由清单文件跟踪。

日志重写
正如您可以猜到的那样，随着写入操作的执行，AOF 会变得越来越大。例如，如果将计数器递增 100 倍，则最终将在数据集中得到一个包含最终值的键，但在 AOF 中包含 100 个条目。不需要其中 99 个条目来重建当前状态。

重写是完全安全的。当 Redis 继续追加到旧文件时，将生成一个全新的文件，其中包含创建当前数据集所需的最少操作集，一旦第二个文件准备就绪，Redis 就会切换两个文件并开始追加到新文件。

因此，Redis支持一个有趣的功能：它能够在后台重建AOF，而不会中断对客户端的服务。每当您发出BGREWRITEAOF Redis时，Redis都会写入在内存中重建当前数据集所需的最短命令序列。如果您将 AOF 与 Redis 2.2 配合使用，则需要不时运行 BGREWRITEAOF。由于 Redis 2.4 能够自动触发日志重写（有关详细信息，请参阅示例配置文件）。

从 Redis 7.0.0 开始，当计划重写 AOF 时，Redis 父进程将打开一个新的增量 AOF 文件以继续写入。子进程执行重写逻辑并生成新的基本 AOF。Redis 将使用临时清单文件来跟踪新生成的基本文件和增量文件。准备就绪后，Redis 将执行原子替换操作，以使此临时清单文件生效。为了避免在 AOF 重写反复失败和重试时创建许多增量文件的问题，Redis 引入了 AOF 重写限制机制，以确保以越来越慢的速度重试失败的 AOF 重写。

仅追加文件的持久性如何？
您可以配置 Redis 在磁盘上同步数据的次数。有三个选项：

appendfsync always：每次将新命令追加到 AOF 时。非常非常慢，非常安全。请注意，在执行来自多个客户端或管道的一批命令后，这些命令将附加到 AOF，因此这意味着一次写入和一次 fsync（在发送回复之前）。fsync
appendfsync everysec：每秒。足够快（因为版本 2.4 可能与快照一样快），如果发生灾难，您可能会丢失 1 秒钟的数据。fsync
appendfsync no：从不，只需将您的数据交到操作系统手中即可。更快，更不安全的方法。通常，Linux 使用此配置每 30 秒刷新一次数据，但这取决于内核的确切调整。fsync
建议的（也是默认的）策略是每秒。它既非常快又非常安全。该策略在实践中非常慢，但它支持组提交，因此如果有多个并行写入，Redis 将尝试执行单个操作。fsyncalwaysfsync

如果我的 AOF 被截断，我该怎么办？
服务器在写入 AOF 文件时崩溃，或者存储 AOF 文件的卷在写入时已满。发生这种情况时，AOF 仍包含表示数据集的给定时间点版本的一致数据（使用默认 AOF fsync 策略时，该版本可能长达一秒），但 AOF 中的最后一个命令可能会被截断。Redis 的最新主要版本无论如何都可以加载 AOF，只需丢弃文件中最后一个格式不正确的命令即可。在这种情况下，服务器将发出如下所示的日志：

* Reading RDB preamble from AOF file...
* Reading the remaining AOF tail...
# !!! Warning: short read while loading the AOF file !!!
# !!! Truncating the AOF at offset 439 !!!
# AOF loaded anyway because aof-load-truncated is enabled
如果需要，您可以更改默认配置以强制 Redis 在这种情况下停止，但默认配置是继续，而不管文件中的最后一个命令格式不正确，以便保证重新启动后的可用性。

旧版本的 Redis 可能无法恢复，可能需要执行以下步骤：

创建 AOF 文件的备份副本。
使用Redis附带的工具修复原始文件：redis-check-aof

$ redis-check-aof --fix

（可选）用于检查两个文件之间的区别。diff -u

使用固定文件重新启动服务器。

如果我的 AOF 已损坏，我该怎么办？
如果AOF文件不仅被截断，而且被损坏，中间有无效的字节序列，那么事情就会更加复杂。Redis 会在启动时抱怨并中止：

* Reading the remaining AOF tail...
# Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix <filename>
最好的办法是运行该实用程序，最初没有选项，然后了解问题，跳转到文件中的给定偏移量，并查看是否可以手动修复文件：AOF使用Redis协议的相同格式，并且手动修复非常简单。否则，可以让实用程序为我们修复文件，但是在这种情况下，从无效部分到文件末尾的所有AOF部分都可能被丢弃，如果损坏恰好在文件的初始部分，则会导致大量数据丢失。redis-check-aof--fix

它是如何运作的
日志重写使用已用于快照的相同写入时复制技巧。这是它的工作原理：

Redis >= 7.0

Redis 分叉，所以现在我们有一个子进程和一个父进程。

子级开始在临时文件中写入新的基础 AOF。

父级打开一个新的增量 AOF 文件以继续写入更新。如果重写失败，则旧的基文件和增量文件（如果有）加上这个新打开的增量文件表示完整的更新数据集，因此我们是安全的。

当子级完成重写基文件时，父级将收到一个信号，并使用新打开的增量文件和子级生成的基本文件来生成临时清单，并保留它。

利润！现在 Redis 执行清单文件的原子交换，以便此 AOF 重写的结果生效。Redis 还会清理旧的基本文件和任何未使用的增量文件。

红< 7.0

Redis 分叉，所以现在我们有一个子进程和一个父进程。

子项开始在临时文件中写入新的 AOF。

父级将所有新更改累积到内存中缓冲区中（但同时它将新更改写入旧的仅追加文件中，因此如果重写失败，我们是安全的）。

当子级完成重写文件时，父级会收到一个信号，并在子级生成的文件末尾追加内存中缓冲区。

利润！现在，Redis 以原子方式将新文件重命名到旧文件上，并开始将新数据追加到新文件中。

如果我当前使用的是 dump.rdb 快照，如何切换到 AOF？
在版本2.0及更高版本中执行此操作的过程不同，因为您可以猜到自Redis 2.2以来它更简单，并且根本不需要重新启动。

Redis >= 2.2

备份最新的 dump.rdb 文件。
将此备份传输到安全的位置。
发出以下两个命令：
redis-cli config set appendonly yes
redis-cli config set save ""
请确保您的数据库包含的键数与切换前所包含的键数相同。
确保将写入操作正确追加到仅追加文件。
第一个 CONFIG 命令启用"仅追加文件"持久性。

第二个 CONFIG 命令用于关闭快照持久性。这是可选的，如果您愿意，可以启用这两种持久性方法。

重要说明：请记住编辑 redis.conf 以打开 AOF，否则，当您重新启动服务器时，配置更改将丢失，服务器将以旧配置重新启动。

瑞迪斯 2.0

备份最新的 dump.rdb 文件。
将此备份传输到安全的位置。
停止对数据库的所有写入！
发出 .这将创建仅追加文件。redis-cli BGREWRITEAOF
在 Redis 完成生成 AOF 转储时停止服务器。
Edit redis.conf end enable only append file persistence。
重新启动服务器。
请确保您的数据库包含的键数与切换前所包含的键数相同。
确保将写入操作正确追加到仅追加文件。
AOF 和 RDB 持久性之间的交互
Redis >= 2.4 可确保避免在 RDB 快照操作仍在进行时触发 AOF 重写，或在 AOF 重写过程中允许 BGSAVE。这可以防止两个 Redis 后台进程同时执行繁重的磁盘 I/O。

当正在进行快照并且用户使用 BGREWRITEAOF 显式请求日志重写操作时，服务器将使用 OK 状态代码进行回复，告知用户已计划该操作，并且一旦快照完成，重写将开始。

如果同时启用了 AOF 和 RDB 持久性，并且 Redis 重新启动 AOF 文件将用于重建原始数据集，因为它保证是最完整的。

备份 Redis 数据
在开始本节之前，请确保阅读以下句子：确保备份数据库。磁盘损坏，云中的实例消失，等等：没有备份意味着数据消失到/dev/null中的巨大风险。

Redis 非常适合数据备份，因为您可以在数据库运行时复制 RDB 文件：RDB 一旦生成，就永远不会被修改，而当它被生成时，它使用一个临时名称，并且只有在新快照完成时才使用 rename（2） 以原子方式重命名为其最终目标。

这意味着在服务器运行时复制 RDB 文件是完全安全的。这是我们的建议：

在服务器中创建一个 cron 作业，在一个目录中创建 RDB 文件的每小时快照，并在另一个目录中创建每日快照。
每次运行 cron 脚本时，请确保调用该命令以确保删除太旧的快照：例如，您可以拍摄最近 48 小时的每小时快照，以及一到两个月的每日快照。确保使用日期和时间信息命名快照。find
每天至少一次确保将 RDB 快照传输到数据中心外部，或者至少在运行 Redis 实例的物理机外部传输 RDB 快照。
备份 AOF 持久性
如果您运行的 Redis 实例仅启用了 AOF 持久性，您仍然可以执行备份。从 Redis 7.0.0 开始，AOF 文件被拆分为多个文件，这些文件驻留在由配置确定的单个目录中。在正常操作期间，您需要做的就是复制/压缩此目录中的文件以实现备份。但是，如果在重写期间执行此操作，则最终可能会得到无效的备份。要解决此问题，您必须在备份期间禁用 AOF 重写：appendddirname

使用
CONFIG SET
关闭自动重写 确保在此期间不要手动启动重写（使用 BGREWRITEAOF）。auto-aof-rewrite-percentage 0
使用
INFO 检查当前是否正在重写，
并验证是否为 0。如果为 1，则需要等待重写完成。persistenceaof_rewrite_in_progress
现在，您可以安全地复制目录中的文件。appenddirname
完成后重新启用重写：
配置集 auto-aof-rewrite-percentage <prev-value>
注意：如果要最大程度地减少禁用 AOF 重写的时间，则可以创建指向（在上面的步骤 3 中）中的文件的硬链接，然后在创建硬链接后重新启用 rewites（步骤 4）。现在，您可以复制/压缩硬链接，并在完成后将其删除。这是有效的，因为 Redis 保证它只追加到此目录中的文件，或者在必要时完全替换它们，因此在任何给定的时间点，内容都应该是一致的。appenddirname

注意：如果要处理服务器在备份期间重新启动的情况，并确保重新启动后不会自动开始重写，则可以更改上面的步骤 1，以通过 CONFIG REWRITE 保留更新的配置。只需确保在完成后重新启用自动重写（步骤 4），并使用另一个配置重写将其保留。

在版本 7.0.0 之前，只需复制 aof 文件即可备份 AOF 文件（如备份 RDB 快照）。该文件可能缺少最终部分，但 Redis 仍能够加载它（请参阅前面有关截断的 AOF 文件的部分）。

灾难恢复
Redis 环境中的灾难恢复与备份基本相同，并且能够在许多不同的外部数据中心传输这些备份。通过这种方式，即使在发生一些灾难性事件，影响 Redis 正在运行的主数据中心并生成其快照时，数据也能得到保护。

由于许多Redis用户都在创业领域，因此没有足够的钱可以花，我们将回顾成本不太高的最有趣的灾难恢复技术。

Amazon S3 和其他类似服务是实施灾难恢复系统的好方法。只需以加密形式将每日或每小时 RDB 快照传输到 S3 即可。您可以使用（在对称加密模式下）加密数据。确保将密码存储在许多不同的安全位置（例如，将副本提供给组织中最重要的人员）。建议使用多种存储服务，以提高数据安全性。gpg -c
使用 SCP（SSH 的一部分）将快照传输到远端服务器。这是一个相当简单和安全的路线：在离你很远的地方得到一个小的VPS，在那里安装ssh，并生成一个没有密码的ssh客户端密钥，然后将其添加到你的小VPS的文件中。您已准备好以自动方式传输备份。在两个不同的提供商中获取至少两个VPS以获得最佳效果。authorized_keys
重要的是要了解，如果不以正确的方式实现，这个系统很容易失败。至少要绝对确保在传输完成后，您可以验证文件大小（应与您复制的文件之一相匹配），并且如果您使用的是VPS，则可以验证SHA1摘要。

如果由于某种原因，新备份的传输不起作用，您还需要某种独立的警报系统。

----------以上内容来自官网-待整理-----------------------------------------------------------
